catalog_url = "http://auto.ria.ua/blocks_search_ajax/search?marka=#{brand}&model=#{model}"

block start
	data = json from catalog_url
	pages = range from 0 to data.result.search_result.count with step 1000

	chunked_ids = process pages using get_ids
	ids = flatten chunked_ids

	ads = process ids using get_ad
	yield ads
end of block

block get_ids with argument page
	page_url = concatenate catalog_url and "&page=#{page}"
	data = json from page_url
	yield data.result.search_result.ids
end of block

block get_ad with argument id
	ad_url = "http://auto.ria.ua/blocks_search/view/auto/#{id}"
	ad_html = html from ad_url
	ad = extract link, year, mileage, location, price, date, phone from ad_html
	yield ad
end of block

link extractor = css h3.head-car h1 | @href | prefix "http://auto.ria.ua"
year extractor = css h3.head-car h1 | @title | trim | /\d{4}$/ | int 
mileage extractor = css .characteristic .item-char | index 0 | text | /^\d+/ | int
location extractor = css span.city a | text | trim
price extractor = css div.price strong.green | text | replace " " with "" | int
date extractor = css span.date-add span | text | parse date "DD.MM.YYYY" | format date "YYYY-MM-DD"
phone extractor = css .phone | text | trim
