[
    
    {
        "type": "block",
        "name": "start",
        "args": [
            "brand",
            "model"
        ],
        "body": [
            {
                "type": "constant",
                "name": "catalog_url",
                "value": "\"http://auto.ria.ua/blocks_search_ajax/search?marka=#{brand}&model=#{model}\""
            },
            {
                "type": "call",
                "func": "download",
                "args": [
                    "\"json\"",
                    "catalog_url"
                ],
                "result": "data"
            },
            {
                "type": "call",
                "func": "range",
                "args": [
                    0,
                    "data.result.search_result.count",
                    1000
                ],
                "result": "pages"
            },
            {
                "type": "call",
                "func": "process",
                "args": [
                    "pages",
                    "get_ids"
                ],
                "result": "chunked_ids"
            },
            {
                "type": "call",
                "func": "flatten",
                "args": [
                    "chunked_ids"
                ],
                "result": "ids"
            },
            {
                "type": "call",
                "func": "process",
                "args": [
                    "ids",
                    "get_ad",
                    [
                        "catalog_url"
                    ]
                ],
                "result": "ads"
            },
            {
                "type": "return",
                "result": "ads"
            }
        ]
    },
    {
        "type": "block",
        "name": "get_ids",
        "args": [
            "page"
        ],
        "body": [
            {
                "type": "call",
                "func": "concatenate",
                "args": [
                    "catalog_url",
                    "\"&page=#{page}\""
                ],
                "result": "page_url"
            },
            {
                "type": "call",
                "func": "download",
                "args": [
                    "\"json\"",
                    "page_url"
                ],
                "result": "data"
            },
            {
                "type": "return",
                "result": "data.result.search_result.ids"
            }
        ]
    },
    {
        "type": "block",
        "name": "get_ad",
        "args": [
            "id"
        ],
        "body": [
            {
                "type": "constant",
                "name": "ad_url",
                "value": "\"http://auto.ria.ua/blocks_search/view/auto/#{id}\""
            },
            {
                "type": "call",
                "func": "download",
                "args": [
                    "\"html\"",
                    "ad_url"
                ],
                "result": "ad_html"
            },
            {
                "type": "call",
                "func": "extract",
                "args": [
                    "{link: linkExtractor, year: yearExtractor, mileage: mileageExtractor, location: locationExtractor, price: priceExtractor, date: dateExtractor, phone: phoneExtractor}",
                    "ad_html"
                ],
                "result": "ad"
            },
            {
                "type": "return",
                "result": "ad"
            }
        ]
    },
    {
        "type": "extractor",
        "name": "link",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\"h3.head-car h1\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getAttribute",
                "args": [
                    "\"href\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "addPrefix",
                "args": [
                    "\"http://auto.ria.ua\""
                ]
            }
        ]
    },
    {
        "type": "extractor",
        "name": "year",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\"h3.head-car h1\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getAttribute",
                "args": [
                    "\"title\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "trim",
                "args": []
            },
            {
                "type": "extractionOperation",
                "func": "regexSelect",
                "args": [
                    "/\\d{4}$/"
                ]
            },
            {
                "type": "extractionOperation",
                "func": "parseInteger",
                "args": []
            }
        ]
    },
    {
        "type": "extractor",
        "name": "mileage",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\".characteristic .item-char\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "indexer",
                "args": [
                    0
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getText",
                "args": []
            },
            {
                "type": "extractionOperation",
                "func": "regexSelect",
                "args": [
                    "/^\\d+/"
                ]
            },
            {
                "type": "extractionOperation",
                "func": "parseInteger",
                "args": []
            }
        ]
    },
    {
        "type": "extractor",
        "name": "location",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\"span.city a\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getText",
                "args": []
            },
            {
                "type": "extractionOperation",
                "func": "trim",
                "args": []
            }
        ]
    },
    {
        "type": "extractor",
        "name": "price",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\"div.price strong.green\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getText",
                "args": []
            },
            {
                "type": "extractionOperation",
                "func": "replace",
                "args": [
                    "\" \"",
                    "\"\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "parseInteger",
                "args": []
            }
        ]
    },
    {
        "type": "extractor",
        "name": "date",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\"span.date-add span\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getText",
                "args": []
            },
            {
                "type": "extractionOperation",
                "func": "parseDate",
                "args": [
                    "\"DD.MM.YYYY\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "formatDate",
                "args": [
                    "\"YYYY-MM-DD\""
                ]
            }
        ]
    },
    {
        "type": "extractor",
        "name": "phone",
        "operations": [
            {
                "type": "extractionOperation",
                "func": "cssSelect",
                "args": [
                    "\".phone\""
                ]
            },
            {
                "type": "extractionOperation",
                "func": "getText",
                "args": []
            },
            {
                "type": "extractionOperation",
                "func": "trim",
                "args": []
            }
        ]
    }
]